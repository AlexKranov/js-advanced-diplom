!function(){"use strict";function t(t,e){return t<0?"error":0===t?"top-left":t===e-1?"top-right":t===e**2-e?"bottom-left":t===e**2-1?"bottom-right":t%e==0?"left":t>0&&t<e-1?"top":t>e**2-e&&t<e**2-1?"bottom":(t+1)%e==0?"right":"center"}class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(t=>this.onNewGameClick(t))),this.saveGameEl.addEventListener("click",(t=>this.onSaveGameClick(t))),this.loadGameEl.addEventListener("click",(t=>this.onLoadGameClick(t))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const s=document.createElement("div");s.classList.add("cell","map-tile",`map-tile-${t(e,this.boardSize)}`),s.addEventListener("mouseenter",(t=>this.onCellEnter(t))),s.addEventListener("mouseleave",(t=>this.onCellLeave(t))),s.addEventListener("click",(t=>this.onCellClick(t))),this.boardEl.appendChild(s)}this.cells=Array.from(this.boardEl.children)}redrawPositions(t){for(const t of this.cells)t.innerHTML="";for(const s of t){const t=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((e=s.character.health)<15?"critical":e<50?"normal":"high")),r.style.width=`${s.character.health}%`,i.appendChild(r),a.appendChild(i),t.appendChild(a)}var e}addCellEnterListener(t){this.cellEnterListeners.push(t)}addCellLeaveListener(t){this.cellLeaveListeners.push(t)}addCellClickListener(t){this.cellClickListeners.push(t)}addNewGameListener(t){this.newGameListeners.push(t)}addSaveGameListener(t){this.saveGameListeners.push(t)}addLoadGameListener(t){this.loadGameListeners.push(t)}onCellEnter(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach((t=>t.call(null,e)))}onCellLeave(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach((t=>t.call(null,e)))}onCellClick(t){const e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach((t=>t.call(null,e)))}onNewGameClick(t){t.preventDefault(),this.newGameListeners.forEach((t=>t.call(null)))}onSaveGameClick(t){t.preventDefault(),this.saveGameListeners.forEach((t=>t.call(null)))}onLoadGameClick(t){t.preventDefault(),this.loadGameListeners.forEach((t=>t.call(null)))}static showError(t){alert(t)}static showMessage(t){alert(t)}selectCell(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(t),this.cells[t].classList.add("selected",`selected-${e}`)}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter((t=>t.startsWith("selected"))))}showCellTooltip(t,e){this.cells[e].title=t}hideCellTooltip(t){this.cells[t].title=""}showDamage(t,e){return new Promise((s=>{const a=this.cells[t],i=document.createElement("span");i.textContent=e,i.classList.add("damage"),a.appendChild(i),i.addEventListener("animationend",(()=>{a.removeChild(i),s()}))}))}setCursor(t){this.boardEl.style.cursor=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var s="prairie",a="desert",i="arctic",r="mountain";function*o(t,e){for(h(t);;){const s=Math.floor(Math.random()*t.length),a=Math.floor(Math.random()*e);yield new t[s](a)}}function l(t,e,s){h(t);const a=[];for(let i=0;i<s;i++)a.push(o(t,e).next().value);return a}function h(t){if("function"!=typeof t[Symbol.iterator])throw new Error("argument not iterable");t.forEach((t=>{if("function"!=typeof t)throw new Error("character not class")}))}class n{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=t,this.attack=0,this.defence=0,this.health=50,this.type=e,this.position=void 0,"Character"===new.target.name)throw new Error("error")}levelUp(){this.level+=1,this.attack=Math.max(this.attack,this.attack*(1.8-this.health)),this.health=this.health+80>100?100:this.health+80}getAttack(t){const e=Math.max(t.attack-this.defence,.1*t.attack);return this.health=this.health-e,e}}class c extends n{constructor(t){super(t),this.type="daemon",this.level=t,this.attack=10,this.defence=40,this.step=2,this.attackRadius=2}static getType(){return"daemon"}}class d extends n{constructor(t){super(t),this.type="magician",this.level=t,this.attack=10,this.defence=40,this.step=1,this.attackRadius=4}static getType(){return"magician"}}class m extends n{constructor(t){super(t),this.type="vampire",this.level=t,this.attack=25,this.defence=25,this.step=2,this.attackRadius=2}static getType(){return"vampire"}}class u extends n{constructor(t){super(t),this.type="undead",this.level=t,this.attack=40,this.defence=10,this.step=4,this.attackRadius=1}static getType(){return"undead"}}class p extends n{constructor(t){super(t),this.type="swordsman",this.level=t,this.attack=40,this.defence=10,this.step=4,this.attackRadius=1}static getType(){return"swordsman"}}class g extends n{constructor(t){super(t),this.type="bowman",this.level=t,this.attack=25,this.defence=25,this.step=2,this.attackRadius=2}static getType(){return"bowman"}}class C{static getPlayerTeam(){return[g,p,d]}static getComputerTeam(){return[c,m,u]}static getCharacter(t){return[g,p,d,c,m,u].filter((e=>e.getType()===t))}static getPlayerPosition(t){const e=[];let s=0,a=1;for(let t=0;t<16;t++)e.push(s),e.push(a),s+=8,a+=8;return e.includes(t)?(e.splice(e.indexOf(t),1),e[Math.floor(15*Math.random())]):e[Math.floor(16*Math.random())]}static getComputerPosition(t){const e=[];let s=6,a=7;for(let t=0;t<16;t++)e.push(s),e.push(a),s+=8,a+=8;return e.includes(t)?(e.splice(e.indexOf(t),1),e[Math.floor(15*Math.random())]):e[Math.floor(16*Math.random())]}}class y{constructor(t,e){if(!(t instanceof n))throw new Error("character must be instance of Character or its children");if("number"!=typeof e)throw new Error("position must be a number");this.character=t,this.position=e}}const P=new e;P.bindToDOM(document.querySelector("#game-container"));const f=new class{constructor(t){this.storage=t}save(t){this.storage.setItem("state",JSON.stringify(t))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(t){throw new Error("Invalid state")}}}(localStorage),v=new class{constructor(t,e){this.gamePlay=t,this.stateService=e,this.computerTeam=null,this.playerTeam=null,this.exception=null,this.currentCharacter=void 0,this.initialState={currentTurn:"Player",currentCharacter:void 0,selectCell:null,availableMoves:[],attackRadius:[],playerCharacters:[],computerCharacters:[],level:1,computerPoints:0,playerPoints:0},this.state=Object.assign({},this.initialState)}init(){this.gamePlay.drawUi(s),this.addListeners(),this.state.computerCharacters=l(C.getComputerTeam(),1,2),this.state.playerCharacters=l(C.getPlayerTeam(),1,2),this.gamePlay.redrawPositions(this.getCharactersPositions())}getCharactersPositions(){const t=[];return this.state.computerCharacters.forEach((e=>{const s=C.getComputerPosition(this.exception);this.exception=s,e.position=s,t.push(new y(e,s))})),this.state.playerCharacters.forEach((e=>{const s=C.getPlayerPosition(this.exception);this.exception=s,e.position=s,t.push(new y(e,s))})),this.exception=null,t}getNewPositions(){const t=[];return console.log("state",this.state),this.state.computerCharacters.forEach((e=>{t.push(new y(e,e.position))})),this.state.playerCharacters.forEach((e=>{t.push(new y(e,e.position))})),console.log("redraw",t),t}addListeners(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.onNewGameClick.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGameClick.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGameClick.bind(this))}onNewGameClick(){0===this.gamePlay.cellEnterListeners.length&&(this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this))),this.gamePlay.drawUi(s),this.state.computerCharacters=l(C.getComputerTeam(),1,2),this.state.playerCharacters=l(C.getPlayerTeam(),1,2),this.gamePlay.redrawPositions(this.getCharactersPositions()),this.createGameState(Object.assign(this.initialState,{playerCharacters:this.state.playerCharacters,computerCharacters:this.state.computerCharacters,currentTurn:"Player",level:1}))}onSaveGameClick(){this.stateService.save(class{static from(t){return t||null}}.from(this.state)),e.showMessage("Игра сохранена")}onLoadGameClick(){try{const t=this.stateService.load();if(t){this.state=Object.assign(this.state,t),console.log("old",this.state);const e=this.state.playerCharacters.map((t=>{if("bowman"===t.type){const e=new g(t.level);for(let s in t)e[s]=t[s];return e}if("swordsman"===t.type){const e=new p(t.level);for(let s in t)e[s]=t[s];return e}{const e=new d(t.level);for(let s in t)e[s]=t[s];return e}})),s=this.state.computerCharacters.map((t=>{if("daemon"===t.type){const e=new c(t.level);for(let s in t)e[s]=t[s];return e}if("vampire"===t.type){const e=new m(t.level);for(let s in t)e[s]=t[s];return e}{const e=new u(t.level);for(let s in t)e[s]=t[s];return e}}));this.state={...this.state,playerCharacters:e,computerCharacters:s},console.log("new",this.state),this.gamePlay.redrawPositions(this.getNewPositions())}}catch(t){e.showError(t.message)}}onCellClick(t){if(this.characterOnCell=this.gamePlay.cells[t].firstElementChild,this.characterOnCell&&"Player"===this.state.currentTurn){const s=[...this.state.playerCharacters].find((e=>e.position===t)),a=[...this.state.computerCharacters].find((e=>e.position===t));if(s)this.deselectCells(),this.gamePlay.selectCell(t),this.createGameState({currentTurn:"Player",currentCharacter:s,selectCell:t,availableMoves:this.getAvaliblePositions(t,s.step),attackRadius:this.checkAttack(t,s.attackRadius)});else if(a&&this.state.currentCharacter){if(this.state.attackRadius.includes(t)){const e=a.getAttack(this.state.currentCharacter);this.deselectCells(),this.checkHealthCharacters(),this.gamePlay.showDamage(t,e).then((()=>{this.gamePlay.redrawPositions(this.getNewPositions()),this.createGameState(Object.assign(this.initialState,{playerCharacters:this.state.playerCharacters,computerCharacters:this.state.computerCharacters,currentTurn:"Computer"}));const{computerCharacters:t,playerCharacters:e}=this.state;0===t.length||0===e.length?this.setNextLevel():this.computerStep()}))}}else e.showError("Вы можете выбирать только своего персонажа")}else if(this.state.currentCharacter&&"Player"===this.state.currentTurn&&this.state.availableMoves.includes(t)){[...this.state.playerCharacters,...this.state.computerCharacters].find((t=>t.position===this.state.selectCell)).position=t,this.deselectCells(),this.gamePlay.redrawPositions(this.getNewPositions()),this.createGameState(Object.assign(this.initialState,{playerCharacters:this.state.playerCharacters,computerCharacters:this.state.computerCharacters,currentTurn:"Computer"}));const{computerCharacters:e,playerCharacters:s}=this.state;0===e.length||0===s.length?this.setNextLevel():this.computerStep()}console.log(this.state)}deselectCells(){this.gamePlay.cells.forEach(((t,e)=>{t.classList.contains("selected")&&this.gamePlay.deselectCell(e)}))}onCellEnter(t){if(this.characterOnCell=this.gamePlay.cells[t].firstElementChild,this.state.currentCharacter)this.state.attackRadius.includes(t)&&this.checkPosition(t,this.state.computerCharacters)?(this.clearCells(),this.gamePlay.setCursor("crosshair"),this.gamePlay.selectCell(t,"red")):this.state.availableMoves.includes(t)?(this.clearCells(),this.gamePlay.setCursor("pointer"),this.gamePlay.selectCell(t,"green")):this.checkPosition(t,this.state.playerCharacters)?(this.gamePlay.setCursor("pointer"),this.clearCells()):(this.gamePlay.setCursor("not-allowed"),this.clearCells());else if(this.characterOnCell){const e=[...this.state.playerCharacters,...this.state.computerCharacters].find((e=>e.position===t));this.state.playerCharacters.includes(e)?this.gamePlay.setCursor("pointer"):this.gamePlay.setCursor("not-allowed");const s=this.createToolTip(e);this.gamePlay.showCellTooltip(s,t)}else this.gamePlay.setCursor("auto")}clearCells(){const t=this.gamePlay.cells.findIndex((t=>t.classList.contains("selected-green"))),e=this.gamePlay.cells.findIndex((t=>t.classList.contains("selected-red")));-1!==t&&this.gamePlay.deselectCell(t),-1!==e&&this.gamePlay.deselectCell(e)}onCellLeave(t){this.gamePlay.hideCellTooltip(t)}createToolTip(t){return`🎖 ${t.level} ⚔ ${t.attack} 🛡 ${t.defence} ❤ ${t.health}`}createGameState(t){this.state=Object.assign(this.state,t)}getAvaliblePositions(t,e){return[...this.getTopPositions(t,e),...this.getLeftPositions(t,e),...this.getRightPositions(t,e),...this.getBottomPositions(t,e),...this.getTopRightPositions(t,e),...this.getTopLeftPositions(t,e),...this.getBottomLeftPositions(t,e),...this.getBottomRightPositions(t,e)].filter((t=>!this.checkPosition(t,[...this.state.playerCharacters,...this.state.computerCharacters])))}getPositions(e,s,a,i){const r=[];for(let o=0;o<=a;o++){const a=i(o,s),l=t(a,this.gamePlay.boardSize),h=e.some((t=>t===l));if(h&&0===o)break;if(0!==o){if(r.push(a),h)break}else if(h)break}return r}getTopPositions(t,e){return this.getPositions(["top-left","top-right","top","error"],t,e,((t,e)=>e-this.gamePlay.boardSize*t))}getLeftPositions(t,e){return this.getPositions(["top-left","left","error","bottom-left"],t,e,((t,e)=>e-1*t))}getRightPositions(t,e){return this.getPositions(["top-right","right","error","bottom-right"],t,e,((t,e)=>e+1*t))}getBottomPositions(t,e){return this.getPositions(["bottom-left","bottom","error","bottom-right"],t,e,((t,e)=>e+this.gamePlay.boardSize*t))}getTopRightPositions(t,e){return this.getPositions(["top-left","top","error","top-right","right","bottom-right"],t,e,((t,e)=>e-this.gamePlay.boardSize*t+t))}getTopLeftPositions(t,e){return this.getPositions(["top-left","top","error","top-right","left","bottom-left"],t,e,((t,e)=>e-this.gamePlay.boardSize*t-t))}getBottomLeftPositions(t,e){return this.getPositions(["top-left","bottom","error","bottom-right","left","bottom-left"],t,e,((t,e)=>e+this.gamePlay.boardSize*t-t))}getBottomRightPositions(t,e){return this.getPositions(["top-right","bottom","error","bottom-right","right","bottom-left"],t,e,((t,e)=>e+this.gamePlay.boardSize*t+t))}checkPosition(t,e){return e.find((e=>e.position===t))}getAttackRadius(t,e,s){const a=[],i=this.gamePlay.boardSize;if(e.length>0&&s.length>0)for(let r=0;r<this.getMostLength(e,s).length;r++)for(let o=0;o<this.getMostLength(e,s).length;o++){const e=t(s[r],i,o);e>=0&&!this.checkPosition(e,this.state.playerCharacters)&&a.push(e)}return a}getTopRightAttack(t,e){return this.getAttackRadius(((t,e,s)=>t-e*(s+1)),t,e)}getTopLefttAttack(t,e){return this.getAttackRadius(((t,e,s)=>t-e*(s+1)),t,e)}getBottomRightAttack(t,e){return this.getAttackRadius(((t,e,s)=>t+e*(s+1)),t,e)}getBottomLeftAttack(t,e){return this.getAttackRadius(((t,e,s)=>t+e*(s+1)),t,e)}checkAttack(t,e){const s=this.getTopPositions(t,e),a=this.getLeftPositions(t,e),i=this.getRightPositions(t,e),r=this.getBottomPositions(t,e),o=this.getTopRightAttack(s,a),l=this.getTopLefttAttack(s,i),h=this.getBottomRightAttack(r,a),n=this.getBottomLeftAttack(r,i);return[...s,...a,...i,...r,...o,...l,...n,...h]}getMostLength(t,e){return t.length>e.length?t:e}computerStep(){const t=this.state.computerCharacters,e=t[Math.floor(Math.random()*t.length)];this.createGameState({currentTurn:"Computer",currentCharacter:e,selectCell:e.position,availableMoves:this.getAvaliblePositions(e.position,e.step),attackRadius:this.checkAttack(e.position,e.attackRadius)});const s=this.state.playerCharacters.find((t=>this.state.attackRadius.includes(t.position)));if(s){const t=s.getAttack(e);this.gamePlay.showDamage(s.position,t).then((()=>{this.checkHealthCharacters(),this.gamePlay.redrawPositions(this.getNewPositions()),this.createGameState(Object.assign(this.initialState,{playerCharacters:this.state.playerCharacters,computerCharacters:this.state.computerCharacters,currentTurn:"Player"}));const{computerCharacters:t,playerCharacters:e}=this.state;0!==t.length&&0!==e.length||this.setNextLevel()}))}else{const t=this.state.availableMoves[Math.floor(Math.random()*this.state.availableMoves.length)];e.position=t,this.gamePlay.redrawPositions(this.getNewPositions()),this.createGameState(Object.assign(this.initialState,{playerCharacters:this.state.playerCharacters,computerCharacters:this.state.computerCharacters,currentTurn:"Player"}))}const{computerCharacters:a,playerCharacters:i}=this.state;0!==a.length&&0!==i.length||this.setNextLevel(),console.log(this.state)}checkHealthCharacters(){this.state.computerCharacters=this.state.computerCharacters.filter((t=>t.health>0)),this.state.playerCharacters=this.state.playerCharacters.filter((t=>t.health>0))}setNextLevel(){this.setPoints(),this.state.level+=1,2===this.state.level?(this.gamePlay.drawUi(a),this.createLevel(3)):3===this.state.level?(this.gamePlay.drawUi(i),this.createLevel(5)):4===this.state.level?(this.gamePlay.drawUi(r),this.createLevel(7)):(this.gamePlay.cellEnterListeners=[],this.gamePlay.cellLeaveListeners=[],this.gamePlay.cellClickListeners=[],this.state.playerPoints>this.state.computerPoints?e.showMessage(`Победил Player, счет ${this.state.playerPoints} : ${this.state.computerPoints}`):e.showMessage(`Победил Computer, счет ${this.state.playerPoints} : ${this.state.computerPoints}`))}createLevel(t){const e=this.state.level;[...this.state.playerCharacters,...this.state.computerCharacters].forEach((t=>{t.levelUp()})),this.state.computerCharacters=[...this.state.computerCharacters,...l(C.getComputerTeam(),e-1,t-this.state.computerCharacters.length)],this.state.playerCharacters=[...this.state.playerCharacters,...l(C.getPlayerTeam(),e,t-this.state.playerCharacters.length)],this.gamePlay.redrawPositions(this.getCharactersPositions()),this.createGameState(Object.assign(this.initialState,{playerCharacters:this.state.playerCharacters,computerCharacters:this.state.computerCharacters,currentTurn:"Player",level:e,playerPoints:this.state.playerPoints,computerPoints:this.state.computerPoints}))}setPoints(){const{computerCharacters:t,playerCharacters:e}=this.state;this.state.computerPoints=t.reduce(((t,e)=>t+e.health),this.state.computerPoints),this.state.playerPoints=e.reduce(((t,e)=>t+e.health),this.state.playerPoints)}}(P,f);v.init()}();